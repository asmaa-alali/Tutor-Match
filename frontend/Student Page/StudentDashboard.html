<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard — TutorMatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="../common/session-guard.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(18px); border: 1px solid rgba(255,255,255,0.18); }
    .dark .glass { background: rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.08); }
    .gradient {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 20%, rgba(147,51,234,.25), transparent 60%),
                  linear-gradient(135deg, #0f172a 0%, #111827 40%, #0a0a0a 100%);
    }
    .card:hover { transform: translateY(-4px); }
  </style>
</head>
<body class="min-h-screen gradient text-slate-100">
  <!-- Top Bar -->
  <header class="sticky top-0 z-30 backdrop-blur-md border-b border-white/10 bg-black/30">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
          <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
        </div>
        <span class="text-lg font-extrabold tracking-tight">TutorMatch • Student</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="theme-btn" class="glass rounded-xl px-3 py-2 hover:bg-white/10 transition flex items-center gap-2">
          <i data-lucide="moon" class="w-4 h-4"></i>
          <span class="hidden sm:inline text-sm">Dark</span>
        </button>
        <a href="findtutor.html" class="glass rounded-xl px-3 py-2 hover:bg-white/10 transition flex items-center gap-2">
          <i data-lucide="search" class="w-4 h-4"></i>
          <span class="hidden sm:inline text-sm">Find Tutor</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-4 pt-10 pb-6">
    <div class="grid md:grid-cols-[1.2fr_.8fr] gap-6 items-stretch">
      <div class="glass rounded-3xl p-7 border-white/10">
        <div class="flex items-center gap-3 mb-4 text-blue-300">
          <i data-lucide="sparkles" class="w-5 h-5"></i>
          <span class="text-sm font-semibold uppercase tracking-wider">Welcome</span>
        </div>
        <h1 class="text-3xl sm:text-4xl font-black leading-tight" id="studentGreeting">
          Your Student Dashboard ✨
        </h1>
        <p class="mt-3 text-slate-300 leading-relaxed" id="studentWelcomeSub">
          Quickly jump to the key student pages: browse tutors, view and update your profile, and tweak your app settings.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="findtutor.html" class="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-3 font-semibold shadow-lg hover:shadow-xl transition card">
            <i data-lucide="search" class="w-5 h-5"></i>
            Find a Tutor
          </a>
          <a href="MyProfile.html" class="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 px-5 py-3 font-semibold shadow-lg hover:shadow-xl transition card">
            <i data-lucide="user" class="w-5 h-5"></i>
            My Profile
          </a>
          <a href="settings.html" class="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-600 to-teal-600 px-5 py-3 font-semibold shadow-lg hover:shadow-xl transition card">
            <i data-lucide="settings" class="w-5 h-5"></i>
            Settings
          </a>
        </div>
      </div>

    </div>
  </section>

  <!-- Main Cards -->
  <main class="max-w-6xl mx-auto px-4 pb-16">
    <div class="grid md:grid-cols-3 gap-6">
      <!-- Find Tutor -->
      <a href="findtutor.html" class="block glass rounded-3xl p-6 border-white/10 hover:bg-white/10 transition card">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
              <i data-lucide="search" class="w-5 h-5 text-white"></i>
            </div>
            <h2 class="text-lg font-extrabold">Find a Tutor</h2>
          </div>
          <i data-lucide="arrow-up-right" class="w-5 h-5 text-slate-300"></i>
        </div>
        <p class="mt-3 text-sm text-slate-300">Discover top-rated AUB tutors by subject, rating, price, or availability.</p>
      </a>

      <!-- My Profile -->
      <a href="MyProfile.html" class="block glass rounded-3xl p-6 border-white/10 hover:bg-white/10 transition card">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
              <i data-lucide="user" class="w-5 h-5 text-white"></i>
            </div>
            <h2 class="text-lg font-extrabold">My Profile</h2>
          </div>
          <i data-lucide="arrow-up-right" class="w-5 h-5 text-slate-300"></i>
        </div>
        <p class="mt-3 text-sm text-slate-300">Update personal and academic information, adjust subjects, and add fresh profile details.</p>
      </a>

      <!-- Settings -->
      <a href="settings.html" class="block glass rounded-3xl p-6 border-white/10 hover:bg-white/10 transition card">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
              <i data-lucide="settings" class="w-5 h-5 text-white"></i>
            </div>
            <h2 class="text-lg font-extrabold">Settings</h2>
          </div>
          <i data-lucide="arrow-up-right" class="w-5 h-5 text-slate-300"></i>
        </div>
        <p class="mt-3 text-sm text-slate-300">Update contact info, change your password, tweak security, and adjust app preferences.</p>
      </a>
    </div>

  </main>

  <footer class="border-t border-white/10 py-8 text-center text-slate-400">
    <div class="max-w-6xl mx-auto px-4 text-sm">© <span id="y"></span> TutorMatch — Student Dashboard</div>
  </footer>

  <script src="student-session.js"></script>
  <script>
    // Icons
    lucide.createIcons();

    // Dark mode toggle (localStorage based)
    const html = document.documentElement;
    const themeBtn = document.getElementById('theme-btn');
    const THEME_KEY = 'tm-theme';

    function applyTheme() {
      const saved = localStorage.getItem(THEME_KEY) || 'dark';
      if (saved === 'dark') {
        html.classList.add('dark');
        themeBtn.querySelector('i').setAttribute('data-lucide', 'sun');
      } else {
        html.classList.remove('dark');
        themeBtn.querySelector('i').setAttribute('data-lucide', 'moon');
      }
      lucide.createIcons();
    }

    themeBtn.addEventListener('click', () => {
      const isDark = html.classList.toggle('dark');
      localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
      applyTheme();
    });

    applyTheme();

    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // Simple keyboard shortcuts
    const go = (path) => { window.location.href = path; };
    window.addEventListener('keydown', (e) => {
      if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
      if (e.key.toLowerCase() === 'f') go('findtutor.html');
      if (e.key.toLowerCase() === 'p') go('MyProfile.html');
      if (e.key.toLowerCase() === 's') go('settings.html');
    });

    const DASH_SESSION_KEY = 'tmUserSession';
    let dashSession = null;
    let dashSubjects = [];
    let dashEditing = false;
    let dashSaving = false;

    const dashEls = {
      fullName: document.getElementById('dashFullName'),
      email: document.getElementById('dashEmail'),
      phone: document.getElementById('dashPhone'),
      studentId: document.getElementById('dashStudentId'),
      university: document.getElementById('dashUniversity'),
      major: document.getElementById('dashMajor'),
      year: document.getElementById('dashYearOfStudy'),
      subjectTags: document.getElementById('dashSubjectTags'),
      editBtn: document.getElementById('dashEditBtn'),
      cancelBtn: document.getElementById('dashCancelBtn'),
      saveBtn: document.getElementById('dashSaveBtn'),
    };

    const dashInputs = [
      dashEls.fullName,
      dashEls.email,
      dashEls.phone,
      dashEls.studentId,
      dashEls.university,
      dashEls.major,
    ].filter(Boolean);

    function getDashSession() {
      try {
        const raw = localStorage.getItem(DASH_SESSION_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (err) {
        console.warn('Failed to parse stored session:', err);
        return null;
      }
    }

    async function refreshDashSessionFromServer(stored) {
      if (!stored || (stored.role && stored.role !== 'student')) return null;
      const userId = typeof stored.userId === 'string' ? stored.userId.trim() : '';
      if (!userId) return null;

      try {
        const response = await fetch(`http://localhost:3000/api/students/profile/${encodeURIComponent(userId)}`);
        if (!response.ok) {
          let message = 'Failed to load profile.';
          try {
            const data = await response.json();
            if (data?.error) message = data.error;
          } catch {}
          throw new Error(message);
        }

        const serverData = await response.json();
        const profile = serverData?.profile || {};
        const updatedSession = {
          ...stored,
          userId: serverData?.userId || stored.userId,
          email: serverData?.email || stored.email || '',
          role: stored.role || 'student',
          profile: {
            ...(stored.profile || {}),
            ...profile,
            subjects: Array.isArray(profile.subjects) ? profile.subjects : stored.profile?.subjects || [],
          },
          passwordUpdatedAt: serverData?.passwordUpdatedAt ?? stored.passwordUpdatedAt ?? null,
        };

        dashSubjects = Array.isArray(updatedSession.profile.subjects)
          ? [...updatedSession.profile.subjects]
          : [];

        localStorage.setItem(DASH_SESSION_KEY, JSON.stringify(updatedSession));
        dashSession = updatedSession;
        return updatedSession;
      } catch (err) {
        console.error('Dashboard profile fetch failed:', err);
        showDashToast(err.message || 'Unable to refresh your profile.', 'error');
        return null;
      }
    }

    function renderDashSubjects() {
      if (!dashEls.subjectTags) return;
      dashEls.subjectTags.innerHTML = '';
      if (!dashSubjects.length) {
        const span = document.createElement('span');
        span.className = 'text-slate-400';
        span.textContent = dashEditing ? 'Subjects editing is available in My Profile.' : 'No subjects added yet.';
        dashEls.subjectTags.appendChild(span);
        return;
      }

      dashSubjects.forEach((subject) => {
        const tag = document.createElement('span');
        tag.className = 'px-3 py-1 rounded-full border border-white/15 bg-white/10 text-slate-200';
        tag.textContent = subject;
        dashEls.subjectTags.appendChild(tag);
      });
    }

    function populateDashProfile(session) {
      const profile = session?.profile || {};
      const firstName = (profile.firstName || '').trim();
      const lastName = (profile.lastName || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');

      if (dashEls.fullName) dashEls.fullName.value = fullName;
      if (dashEls.email) dashEls.email.value = (session?.email || '').trim();
      if (dashEls.phone) dashEls.phone.value = (profile.phone || '').trim();
      if (dashEls.studentId) dashEls.studentId.value = (profile.studentId || '').trim();
      if (dashEls.university) dashEls.university.value = (profile.university || '').trim();
      if (dashEls.major) dashEls.major.value = (profile.major || '').trim();

      if (dashEls.year) {
        const currentYear = (profile.currentYear || '').trim();
        if (currentYear && Array.from(dashEls.year.options).some(opt => opt.value === currentYear)) {
          dashEls.year.value = currentYear;
        } else {
          dashEls.year.value = '';
        }
      }

      dashSubjects = Array.isArray(profile.subjects) ? [...profile.subjects] : [];
      renderDashSubjects();
    }

    function toggleDashEditing(enabled) {
      dashEditing = enabled;
      dashInputs.forEach((input) => {
        if (!input) return;
        if (enabled) {
          input.removeAttribute('readonly');
          input.classList.add('focus:ring-2');
        } else {
          input.setAttribute('readonly', 'readonly');
          input.classList.remove('focus:ring-2');
        }
      });

      if (dashEls.year) {
        if (enabled) dashEls.year.removeAttribute('disabled');
        else dashEls.year.setAttribute('disabled', 'disabled');
      }

      if (dashEls.editBtn) dashEls.editBtn.classList.toggle('hidden', enabled);
      if (dashEls.saveBtn) dashEls.saveBtn.classList.toggle('hidden', !enabled);
      if (dashEls.cancelBtn) dashEls.cancelBtn.classList.toggle('hidden', !enabled);

      renderDashSubjects();
      lucide.createIcons();
    }

    function buildDashPayload() {
      if (!dashSession || !dashSession.userId) {
        showDashToast('Please sign in to edit your profile.', 'error');
        return null;
      }

      const fullNameRaw = (dashEls.fullName?.value || '').trim();
      const emailRaw = (dashEls.email?.value || '').trim();
      const majorRaw = (dashEls.major?.value || '').trim();

      if (!fullNameRaw || !emailRaw || !majorRaw) {
        showDashToast('Full name, email, and major are required.', 'error');
        return null;
      }

      const nameParts = fullNameRaw.split(/\s+/);
      const firstName = nameParts.shift() || '';
      const lastName = nameParts.join(' ');

      return {
        userId: dashSession.userId,
        email: emailRaw,
        firstName,
        lastName,
        phone: (dashEls.phone?.value || '').trim(),
        university: (dashEls.university?.value || '').trim(),
        major: majorRaw,
        currentYear: (dashEls.year?.value || '').trim(),
        studentId: (dashEls.studentId?.value || '').trim(),
        subjects: [...dashSubjects],
      };
    }

    function showDashToast(message, type = 'info') {
      const toast = document.createElement('div');
      const color =
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `fixed top-6 right-6 ${color} text-white px-5 py-3 rounded-xl shadow-lg z-50 transform translate-x-full transition`;
      toast.innerHTML = `
        <div class="flex items-center gap-2">
          <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'info'}" class="w-4 h-4"></i>
          <span class="text-sm">${message}</span>
        </div>
      `;

      document.body.appendChild(toast);
      lucide.createIcons();

      requestAnimationFrame(() => {
        toast.style.transform = 'translateX(0)';
      });

      setTimeout(() => {
        toast.style.transform = 'translateX(120%)';
        setTimeout(() => toast.remove(), 300);
      }, 3200);
    }

    function updateDashboardGreeting(fullName, firstName) {
      const greeting = document.getElementById('studentGreeting');
      if (greeting && firstName) {
        greeting.textContent = `Welcome back, ${firstName}! ✨`;
      }

      const welcomeSub = document.getElementById('studentWelcomeSub');
      if (welcomeSub && fullName) {
        welcomeSub.textContent = `${fullName}, here’s everything you need for a great study session today.`;
      }
    }

    async function handleDashSave() {
      if (dashSaving) return;
      const payload = buildDashPayload();
      if (!payload) return;

      const button = dashEls.saveBtn;
      const originalHtml = button?.innerHTML;

      if (button) {
        button.disabled = true;
        button.innerHTML = `
          <span class="flex items-center gap-2">
            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
            Saving...
          </span>
        `;
        lucide.createIcons();
      }

      dashSaving = true;

      try {
        const response = await fetch("http://localhost:3000/api/students/profile", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json().catch(() => null);
        if (!response.ok) {
          throw new Error(data?.error || 'Failed to update profile.');
        }

        const serverProfile = data?.profile || {};
        const mergedProfile = {
          ...(dashSession?.profile || {}),
          ...serverProfile,
        };
        mergedProfile.subjects = Array.isArray(serverProfile.subjects)
          ? serverProfile.subjects
          : dashSubjects;

        dashSession = {
          ...(dashSession || {}),
          email: data?.email || payload.email,
          profile: mergedProfile,
        };

        try {
          localStorage.setItem(DASH_SESSION_KEY, JSON.stringify(dashSession));
        } catch (err) {
          console.warn('Failed to persist updated dashboard session:', err);
        }

        dashSubjects = Array.isArray(mergedProfile.subjects) ? [...mergedProfile.subjects] : [];

        populateDashProfile(dashSession);
        toggleDashEditing(false);
        const fullNameRaw = (dashEls.fullName?.value || '').trim();
        const nameParts = fullNameRaw.split(/\s+/);
        const firstName = nameParts[0] || '';
        updateDashboardGreeting(fullNameRaw, firstName);
        showDashToast('Profile updated successfully!', 'success');
      } catch (err) {
        console.error('Dashboard profile save failed:', err);
        showDashToast(err.message || 'Failed to save profile.', 'error');
      } finally {
        dashSaving = false;
        if (button) {
          button.disabled = false;
          button.innerHTML = originalHtml;
          lucide.createIcons();
        }
      }
    }

    async function initializeDashboardProfile() {
      const stored = getDashSession();
      dashSession = stored;
      if (stored?.userId) {
        await refreshDashSessionFromServer(stored);
      }

      dashSession = getDashSession();
      populateDashProfile(dashSession);
      toggleDashEditing(false);

      if (!dashSession?.userId) {
        dashInputs.forEach((input) => input && input.setAttribute('placeholder', 'Sign in to view'));
        showDashToast('Sign in to load and edit your profile.', 'error');
      }
    }

    if (dashEls.editBtn) {
      dashEls.editBtn.addEventListener('click', () => {
        if (!dashSession?.userId) {
          showDashToast('Please sign in to edit your profile.', 'error');
          return;
        }
        toggleDashEditing(true);
        dashEls.fullName?.focus();
      });
    }

    if (dashEls.cancelBtn) {
      dashEls.cancelBtn.addEventListener('click', () => {
        populateDashProfile(dashSession);
        toggleDashEditing(false);
      });
    }

    if (dashEls.saveBtn) {
      dashEls.saveBtn.addEventListener('click', handleDashSave);
    }

    initializeDashboardProfile();
  </script>
</body>
</html>
