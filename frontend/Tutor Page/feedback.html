<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutor Feedback &amp; Ratings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * { 
            font-family: 'Inter', sans-serif; 
        }
        
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 25%, #1d4ed8 50%, #1e3a8a 75%, #312e81 100%);
            min-height: 100%;
            transition: all 0.4s ease;
        }

        body.dark-mode {
            background: #0f172a;
        }

        html, body {
            height: 100%;
        }

        .navbar {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(30, 64, 175, 0.9) 25%, rgba(29, 78, 216, 0.9) 50%, rgba(30, 58, 138, 0.9) 75%, rgba(49, 46, 129, 0.9) 100%);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 30;
            transition: all 0.4s ease;
        }

        .dark-mode .navbar {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .dark-mode .card {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .card:hover {
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .dark-mode .card:hover {
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e3a8a);
            box-shadow: 0 6px 24px rgba(59, 130, 246, 0.6);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
        }

        .form-input {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #1e293b;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .dark-mode .form-input {
            background: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }

        .dark-mode .form-input:focus {
            background: #1e293b;
            border-color: #3b82f6;
        }

        .dark-mode-toggle {
            position: relative;
            width: 82px;
            height: 42px;
            padding: 4px;
            border-radius: 9999px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.35s ease;
            overflow: hidden;
            /* glassy track with subtle gradient */
            background: linear-gradient(135deg, rgba(255,255,255,0.26), rgba(255,255,255,0.1));
            border: 1px solid rgba(255,255,255,0.35);
            box-shadow:
                inset 0 2px 10px rgba(0,0,0,0.18),
                0 6px 20px rgba(30,64,175,0.35);
            backdrop-filter: blur(6px);
        }

        /* animated gradient ring */
        .dark-mode-toggle::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #60a5fa);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.85;
            transition: opacity .35s ease, filter .35s ease;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(99,102,241,0.35));
        }

        .dark-mode-toggle.active {
            background: linear-gradient(135deg, rgba(17,24,39,0.75), rgba(15,23,42,0.9));
            border-color: rgba(59,130,246,0.45);
            box-shadow:
                0 0 24px rgba(59,130,246,0.45),
                inset 0 2px 10px rgba(0,0,0,0.35);
        }

        .dark-mode-toggle.active::before {
            opacity: 1;
            filter: drop-shadow(0 0 14px rgba(59,130,246,0.55));
        }

        .dark-mode-toggle-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fbbf24;
            background: radial-gradient(circle at 30% 30%, #ffffff, #e2e8f0 70%);
            border: 2px solid rgba(255, 255, 255, 0.85);
            box-shadow:
                0 6px 18px rgba(0,0,0,0.25),
                0 2px 6px rgba(0,0,0,0.12);
            transition: transform .45s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                        background .35s ease,
                        color .35s ease,
                        box-shadow .35s ease;
        }

        .dark-mode-toggle-circle i {
            transition: transform .45s ease, opacity .25s ease;
        }

        .dark-mode-toggle:active .dark-mode-toggle-circle {
            transform: scale(0.96);
        }

        .dark-mode-toggle.active .dark-mode-toggle-circle {
            transform: translateX(40px) rotate(-180deg);
            color: #fbbf24;
            background: radial-gradient(circle at 70% 70%, #0f172a, #111827 70%);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow:
                0 8px 24px rgba(59, 130, 246, 0.45),
                0 2px 6px rgba(0, 0, 0, 0.25);
        }

        .rating-stars {
            color: #fbbf24;
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .feedback-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .feedback-card:hover {
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.25);
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .dark-mode .feedback-card {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            border-color: rgba(30, 41, 59, 0.5);
        }

        .dark-mode .feedback-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-mode .gradient-text {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dark-mode .section-title {
            color: #f1f5f9;
        }

        .header-main {
            color: white;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 16px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .header-main {
            color: #f1f5f9;
        }

        .header-sub {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 32px;
        }

        .dark-mode .header-sub {
            color: #cbd5e1;
        }

        .student-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .dark-mode-text {
            color: #1e293b;
        }

        .dark-mode .dark-mode-text {
            color: #cbd5e1;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <header class="navbar">
   <div class="flex items-center justify-between px-8 py-5">
    <div class="flex items-center gap-4"><span class="text-3xl">ðŸŽ“</span>
     <div>
      <h1 class="text-xl font-bold gradient-text">Tutor Match</h1>
      <p class="text-xs text-gray-400">Feedback &amp; Ratings</p>
     </div>
    </div>
    <div class="flex items-center gap-8">
     <div class="dark-mode-toggle" onclick="toggleDarkMode(this)">
      <div class="dark-mode-toggle-circle"><i data-lucide="power" class="w-5 h-5"></i>
      </div>
     </div>
    </div>
   </div>
  </header>
  <main class="p-8">
   <div class="mb-8"><button class="btn-primary mb-6" onclick="window.location.href='tutorpage.html'"> <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i> Back to Home </button>
    <h1 class="header-main">Student Feedback &amp; Ratings</h1>
    <p class="header-sub">View all feedback from your students and track your performance.</p>
   </div><!-- Overall Stats -->
   <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="card p-6 text-center">
     <div id="overallRatingValue" class="text-5xl font-bold gradient-text mb-2">
      --
     </div>
     <div class="rating-stars justify-center mb-2"><i data-lucide="star" class="w-5 h-5 fill-current"></i> <i data-lucide="star" class="w-5 h-5 fill-current"></i> <i data-lucide="star" class="w-5 h-5 fill-current"></i> <i data-lucide="star" class="w-5 h-5 fill-current"></i> <i data-lucide="star" class="w-5 h-5 fill-current"></i>
     </div>
     <p class="text-sm text-gray-600 dark-mode-text">Overall Rating</p>
    </div>
    <div class="card p-6 text-center">
     <div id="positivePercentValue" class="text-5xl font-bold gradient-text mb-2">
      0%
     </div>
     <p class="text-sm text-gray-600 dark-mode-text">Positive Feedback</p>
    </div>
   </div><!-- Rating Breakdown -->
   <div class="card p-8 mb-8">
    <h2 class="section-title"><i data-lucide="bar-chart-3" class="w-7 h-7 text-blue-600"></i> Rating Breakdown</h2>
    <div class="space-y-4">
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 w-24"><span class="font-semibold text-gray-700 dark-mode-text">5</span> <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
       <div id="bar5" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full" style="width: 0%"></div>
      </div><span id="count5" class="font-semibold text-gray-700 dark-mode-text w-16 text-right">0</span>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 w-24"><span class="font-semibold text-gray-700 dark-mode-text">4</span> <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
       <div id="bar4" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full" style="width: 0%"></div>
      </div><span id="count4" class="font-semibold text-gray-700 dark-mode-text w-16 text-right">0</span>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 w-24"><span class="font-semibold text-gray-700 dark-mode-text">3</span> <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
       <div id="bar3" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full" style="width: 0%"></div>
      </div><span id="count3" class="font-semibold text-gray-700 dark-mode-text w-16 text-right">0</span>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 w-24"><span class="font-semibold text-gray-700 dark-mode-text">2</span> <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
       <div id="bar2" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full" style="width: 0%"></div>
      </div><span id="count2" class="font-semibold text-gray-700 dark-mode-text w-16 text-right">0</span>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 w-24"><span class="font-semibold text-gray-700 dark-mode-text">1</span> <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
       <div id="bar1" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full" style="width: 0%"></div>
      </div><span id="count1" class="font-semibold text-gray-700 dark-mode-text w-16 text-right">0</span>
     </div>
    </div>
   </div><!-- Filter and Search -->
   <div class="card p-6 mb-8">
    <div class="flex flex-col md:flex-row gap-4">
     <div class="flex-1 relative"><i data-lucide="search" class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i> <input type="text" id="feedbackSearchBar" placeholder="Search by student name or subject..." class="form-input pl-12" oninput="filterAllFeedback()">
     </div><select id="ratingFilter" class="form-input" onchange="filterAllFeedback()"> <option value="all">All Ratings</option> <option value="5">5 Stars</option> <option value="4">4 Stars</option> <option value="3">3 Stars</option> <option value="2">2 Stars</option> <option value="1">1 Star</option> </select> <select id="subjectFilter" class="form-input" onchange="filterAllFeedback()"> <option value="all">All Subjects</option> <option value="calculus">Calculus</option> <option value="algebra">Algebra</option> <option value="statistics">Statistics</option> <option value="geometry">Geometry</option> </select>
    </div>
   </div><!-- All Feedback -->
   <div class="card p-8">
    <h2 class="section-title"><i data-lucide="message-square" class="w-7 h-7 text-blue-600"></i> All Feedback</h2>
    <div id="allFeedbackContainer" class="space-y-6"><!-- Feedback items will be populated here -->
    </div>
    <div id="loadMoreContainer" class="mt-8 text-center" style="display: none;"><button class="btn-primary" onclick="loadMoreFeedback()"> <i data-lucide="chevron-down" class="w-4 h-4 inline mr-2"></i> Load More Feedback </button>
    </div>
   </div>
  </main>
  <script>
        lucide.createIcons();

        function toggleDarkMode(toggle) {
            document.body.classList.toggle('dark-mode');

            document.querySelectorAll('.dark-mode-toggle').forEach(t => {
                t.classList.toggle('active');
                const icon = t.querySelector('i');
                if (t.classList.contains('active')) {
                    icon.setAttribute('data-lucide', 'moon');
                } else {
                    icon.setAttribute('data-lucide', 'sun');
                }
            });

            lucide.createIcons();
        }

        let allRatings = [];

        function getCurrentTutorId() {
            try {
                const raw = localStorage.getItem('tmUserSession');
                if (raw) {
                    const session = JSON.parse(raw);
                    if (session && session.userId && (session.role === 'tutor' || !session.role)) {
                        return session.userId;
                    }
                }
            } catch (_) {}

            const stored = localStorage.getItem('tutorId');
            return stored || null;
        }

        function formatDate(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = String(name).trim().split(/\s+/);
            const first = parts[0]?.[0] || '';
            const second = parts[1]?.[0] || '';
            return (first + second || first || '?').toUpperCase();
        }

        function renderStats(stats, ratings) {
            const total = stats && typeof stats.totalRatings === 'number'
                ? stats.totalRatings
                : (ratings ? ratings.length : 0);

            const average = stats && typeof stats.averageRating === 'number'
                ? stats.averageRating
                : (total
                    ? ratings.reduce((sum, r) => sum + (r.rating || 0), 0) / total
                    : 0);

            const dist = stats && stats.ratingDistribution
                ? stats.ratingDistribution
                : { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

            const positiveCount = (dist[4] || 0) + (dist[5] || 0);
            const positivePercent = total ? (positiveCount / total) * 100 : 0;

            const overallEl = document.getElementById('overallRatingValue');
            const positiveEl = document.getElementById('positivePercentValue');
            if (overallEl) {
                overallEl.textContent = total ? average.toFixed(1) : '--';
            }
            if (positiveEl) {
                positiveEl.textContent = `${Math.round(positivePercent)}%`;
            }

            for (let star = 5; star >= 1; star--) {
                const count = dist[star] || 0;
                const pct = total ? (count / total) * 100 : 0;
                const bar = document.getElementById(`bar${star}`);
                const countEl = document.getElementById(`count${star}`);
                if (bar) bar.style.width = `${pct}%`;
                if (countEl) countEl.textContent = String(count);
            }
        }

        function renderFeedbackList(ratings) {
            const container = document.getElementById('allFeedbackContainer');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (!container) return;

            container.innerHTML = '';

            if (!ratings || ratings.length === 0) {
                if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                const empty = document.createElement('div');
                empty.className = 'text-center py-12 text-gray-500';
                empty.innerHTML = `
                    <i data-lucide="message-circle" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                    <p class="text-xl font-semibold mb-2">No feedback yet</p>
                    <p class="text-sm">Once students rate you, their feedback will appear here.</p>
                `;
                container.appendChild(empty);
                lucide.createIcons();
                return;
            }

            if (loadMoreContainer) loadMoreContainer.style.display = 'none';

            ratings.forEach((r) => {
                const card = document.createElement('div');
                card.className = 'feedback-card';

                const studentName = r.studentName || 'Student';
                const initials = getInitials(studentName);
                const subject = r.subject || 'General';
                const dateLabel = formatDate(r.createdAt);
                const ratingValue = Number(r.rating) || 0;

                const stars = Array(5).fill(0).map((_, i) =>
                    `<i data-lucide="star" class="w-4 h-4 ${i < ratingValue ? 'fill-current' : ''}"></i>`
                ).join('');

                card.innerHTML = `
                    <div class="flex items-start gap-4 mb-4">
                        <div class="student-avatar" style="background: linear-gradient(135deg, #3b82f6, #1e40af);">
                            ${initials}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 dark-mode-text">${studentName}</h4>
                            <p class="text-sm text-gray-500">${subject}${dateLabel ? ` â€¢ ${dateLabel}` : ''}</p>
                        </div>
                        <div class="rating-stars">
                            ${stars}
                        </div>
                    </div>
                    <p class="text-gray-600 dark-mode-text text-sm">"${r.feedback || ''}"</p>
                `;

                container.appendChild(card);
            });

            lucide.createIcons();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('feedbackSearchBar')?.value.toLowerCase().trim() || '';
            const ratingFilter = document.getElementById('ratingFilter')?.value || 'all';
            const subjectFilter = document.getElementById('subjectFilter')?.value || 'all';

            return allRatings.filter((r) => {
                const name = (r.studentName || '').toLowerCase();
                const subject = (r.subject || '').toLowerCase();

                const matchesSearch =
                    !searchTerm ||
                    name.includes(searchTerm) ||
                    subject.includes(searchTerm);

                const matchesRating =
                    ratingFilter === 'all' || String(r.rating) === ratingFilter;

                const matchesSubject =
                    subjectFilter === 'all' || subject.includes(subjectFilter);

                return matchesSearch && matchesRating && matchesSubject;
            });
        }

        function filterAllFeedback() {
            const filtered = applyFilters();
            renderFeedbackList(filtered);
        }

        async function initFeedbackPage() {
            const tutorId = getCurrentTutorId();
            if (!tutorId) {
                alert("Missing tutor session. Please sign in again.");
                window.location.href = "/Sign in/signin.html";
                return;
            }

            try {
                const [ratingsRes, statsRes] = await Promise.all([
                    fetch(`/api/ratings/${encodeURIComponent(tutorId)}`),
                    fetch(`/api/ratings/${encodeURIComponent(tutorId)}/stats`)
                ]);

                const ratingsPayload = await ratingsRes.json();
                const statsPayload = await statsRes.json();

                if (!ratingsRes.ok) {
                    throw new Error(ratingsPayload.error || "Failed to load ratings");
                }

                allRatings = Array.isArray(ratingsPayload.ratings) ? ratingsPayload.ratings : [];

                renderStats(statsPayload, allRatings);
                renderFeedbackList(allRatings);
            } catch (err) {
                console.error("Failed to load tutor feedback:", err);
                const container = document.getElementById('allFeedbackContainer');
                if (container) {
                    container.innerHTML = '<p class="text-center text-red-200 py-8">Unable to load feedback at the moment.</p>';
                }
            }
        }

        // Initialize on load
        initFeedbackPage();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99b48516c2d3e30a',t:'MTc2MjU5OTEzNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
