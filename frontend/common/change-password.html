<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Change Password - TutorMatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      body { background: linear-gradient(135deg,#0f172a 0%,#1e293b 25%,#334155 50%,#475569 75%,#64748b 100%); min-height: 100vh; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    </style>
  </head>
  <body class="flex items-center justify-center p-6">
    <div class="w-full max-w-md glass-card bg-[rgba(15,23,42,0.8)] backdrop-blur-xl border border-slate-600/30 rounded-2xl p-6 text-slate-100">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-bold">Change Password</h1>
        <a href="/Tutor%20Page/tutorpage.html" class="text-slate-300 hover:text-white text-sm">Home</a>
      </div>
      <p class="text-slate-300 mb-4">Enter a new password for your account.</p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-slate-300 mb-2">New Password</label>
          <input id="newPassword" type="password" class="w-full rounded-lg bg-slate-800/70 border border-slate-600/40 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter new password" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Confirm New Password</label>
          <input id="confirmNewPassword" type="password" class="w-full rounded-lg bg-slate-800/70 border border-slate-600/40 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Confirm new password" />
        </div>
        <button id="saveBtn" class="w-full rounded-xl bg-blue-600 hover:bg-blue-700 py-2.5 font-semibold">Save</button>
      </div>
      <p id="message" class="mt-4 text-sm text-slate-300"></p>
    </div>

    <script>
      function show(msg, type) {
        const el = document.getElementById('message');
        el.textContent = msg || '';
        el.style.color = type === 'error' ? '#fca5a5' : '#bbf7d0';
      }

      document.getElementById('saveBtn').addEventListener('click', async () => {
        try {
          const raw = localStorage.getItem('tmUserSession');
          const session = raw ? JSON.parse(raw) : null;
          const userId = session && session.userId;
          if (!userId) {
            show('Missing session. Please sign in again.', 'error');
            return;
          }
          const newPassword = document.getElementById('newPassword').value;
          const confirm = document.getElementById('confirmNewPassword').value;
          if (!newPassword || !confirm) return show('Please complete all fields.', 'error');
          if (newPassword !== confirm) return show('Passwords do not match.', 'error');
          if (newPassword.length < 8) return show('Password must be at least 8 characters.', 'error');

          const API_BASE = (window.location.origin && window.location.origin.startsWith('http')) ? '' : 'http://localhost:3000';
          const res = await fetch(`${API_BASE}/api/change-password/simple`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, newPassword })
          });
          const body = await res.json().catch(() => ({}));
          if (!res.ok) {
            return show(body.error || 'Failed to update password.', 'error');
          }
          const nowIso = body.passwordUpdatedAt || new Date().toISOString();
          try {
            const updated = Object.assign({}, session, { passwordUpdatedAt: nowIso });
            localStorage.setItem('tmUserSession', JSON.stringify(updated));
          } catch {}
          show('Password changed successfully!', 'success');
        } catch (e) {
          show('Unexpected error. Please try again later.', 'error');
          console.warn('change-password page error:', e);
        }
      });
    </script>
  </body>
  </html>
